apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    api-approved.openshift.io: https://github.com/openshift/api/pull/1773
    api.openshift.io/merged-by-featuregates: "true"
    include.release.openshift.io/ibm-cloud-managed: "true"
    include.release.openshift.io/self-managed-high-availability: "true"
    release.openshift.io/feature-set: DevPreviewNoUpgrade
  labels:
    openshift.io/operator-managed: ""
  name: machineosconfigs.machineconfiguration.openshift.io
spec:
  group: machineconfiguration.openshift.io
  names:
    kind: MachineOSConfig
    listKind: MachineOSConfigList
    plural: machineosconfigs
    singular: machineosconfig
  scope: Cluster
  versions:
  - name: v1
    schema:
      openAPIV3Schema:
        description: |-
          MachineOSConfig describes the configuration for a build process managed by the MCO
          Compatibility level 1: Stable within a major release for a minimum of 12 months or 3 minor releases (whichever is longer).
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec describes the configuration of the machineosconfig
            properties:
              buildInputs:
                description: buildInputs is where user input options for the build
                  live
                properties:
                  baseImagePullSecret:
                    description: |-
                      baseImagePullSecret is the secret used to pull the base image.
                      Must live in the openshift-machine-config-operator namespace if provided.
                      Defaults to using the cluster-wide pull secret if not specified. This is provided during install time of the cluster, and lives in the openshift-config namespace as a secret.
                    properties:
                      name:
                        description: |-
                          name is the name of the secret used to push or pull this MachineOSConfig object.
                          Must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character.
                          This secret must be in the openshift-machine-config-operator namespace.
                        maxLength: 253
                        type: string
                        x-kubernetes-validations:
                        - message: a lowercase RFC 1123 subdomain must consist of
                            lower case alphanumeric characters, '-' or '.', and must
                            start and end with an alphanumeric character.
                          rule: '!format.dns1123Subdomain().validate(self).hasValue()'
                    required:
                    - name
                    type: object
                  baseOSExtensionsImagePullspec:
                    description: |-
                      baseOSExtensionsImagePullspec is the base Extensions image used in the build process
                      The MachineOSConfig object will use the in cluster image registry configuration.
                      If you wish to use a mirror or any other settings specific to registries.conf, please specify those in the cluster wide registries.conf.
                      The format of the image pullspec is:
                      host[:port][/namespace]/name@sha256:<digest>
                      The digest must be 64 characters long, and consist only of lowercase hexadecimal characters, a-f and 0-9.
                    maxLength: 447
                    minLength: 1
                    type: string
                    x-kubernetes-validations:
                    - message: the OCI Image reference must end with a valid '@sha256:<digest>'
                        suffix, where '<digest>' is 64 characters long
                      rule: (self.split('@').size() == 2 && self.split('@')[1].matches('^sha256:[a-f0-9]{64}$'))
                    - message: the OCI Image name should follow the host[:port][/namespace]/name
                        format, resembling a valid URL without the scheme
                      rule: (self.split('@')[0].matches('^([a-zA-Z0-9-]+\\.)+[a-zA-Z0-9-]+(:[0-9]{2,5})?/([a-zA-Z0-9-_]{0,61}/)?[a-zA-Z0-9-_.]*?$'))
                  baseOSImagePullspec:
                    description: |-
                      baseOSImagePullspec is the base OSImage we use to build our custom image.
                      The MachineOSConfig object will use the in cluster image registry configuration.
                      If you wish to use a mirror or any other settings specific to registries.conf, please specify those in the cluster wide registries.conf.
                      The format of the image pullspec is:
                      host[:port][/namespace]/name@sha256:<digest>
                      The digest must be 64 characters long, and consist only of lowercase hexadecimal characters, a-f and 0-9.
                    maxLength: 447
                    minLength: 1
                    type: string
                    x-kubernetes-validations:
                    - message: the OCI Image reference must end with a valid '@sha256:<digest>'
                        suffix, where '<digest>' is 64 characters long
                      rule: (self.split('@').size() == 2 && self.split('@')[1].matches('^sha256:[a-f0-9]{64}$'))
                    - message: the OCI Image name should follow the host[:port][/namespace]/name
                        format, resembling a valid URL without the scheme
                      rule: (self.split('@')[0].matches('^([a-zA-Z0-9-]+\\.)+[a-zA-Z0-9-]+(:[0-9]{2,5})?/([a-zA-Z0-9-_]{0,61}/)?[a-zA-Z0-9-_.]*?$'))
                  containerFile:
                    description: |-
                      containerFile describes the custom data the user has specified to build into the image.
                      This is also commonly called a Dockerfile and you can treat it as such. The content is the content of your Dockerfile.
                      See https://github.com/containers/common/blob/main/docs/Containerfile.5.md for the spec reference.
                      you can specify up to 7 containerFiles
                    items:
                      description: MachineOSContainerfile contains all custom content
                        the user wants built into the image
                      properties:
                        containerfileArch:
                          default: NoArch
                          description: |-
                            containerfileArch describes the architecture this containerfile is to be built for.
                            This arch is optional. If the user does not specify an architecture, it is assumed
                            that the content can be applied to all architectures, or in a single arch cluster: the only architecture.
                          enum:
                          - ARM64
                          - AMD64
                          - PPC64LE
                          - S390X
                          - AArch64
                          - x86_64
                          - NoArch
                          type: string
                        content:
                          description: |-
                            content is an embedded Containerfile/Dockerfile that defines the contents to be built into your image.
                            See https://github.com/containers/common/blob/main/docs/Containerfile.5.md for the spec reference.
                            for example, this would add the tree package to your hosts:
                              FROM configs AS final
                              RUN rpm-ostree install tree && \
                                ostree container commit
                          maxLength: 4096
                          type: string
                      required:
                      - content
                      type: object
                    maxItems: 7
                    minItems: 0
                    type: array
                    x-kubernetes-list-map-keys:
                    - containerfileArch
                    x-kubernetes-list-type: map
                  imageBuilder:
                    description: |-
                      machineOSImageBuilder describes which image builder will be used in each build triggered by this MachineOSConfig.
                      Currently supported type(s): JobImageBuilder
                    properties:
                      imageBuilderType:
                        description: |-
                          imageBuilderType specifies the backend to be used to build the image.
                          Valid options are: JobImageBuilder
                        enum:
                        - JobImageBuilder
                        type: string
                    required:
                    - imageBuilderType
                    type: object
                  releaseVersion:
                    description: |-
                      releaseVersion is an Openshift release version which the base OS image is associated with.
                      This field is populated from the machine-config-osimageurl configmap in the openshift-machine-config-operator namespace.
                      It will come in the format: 4.16.0-0.nightly-2024-04-03-065948 or any valid release. The MachineOSBuilder populates this field and validates that this is a valid stream.
                      This is used as a label in the Containerfile that builds the OS image.
                    maxLength: 253
                    type: string
                    x-kubernetes-validations:
                    - message: a lowercase RFC 1123 subdomain must consist of lower
                        case alphanumeric characters, '-' or '.', and must start and
                        end with an alphanumeric character.
                      rule: '!format.dns1123Subdomain().validate(self).hasValue()'
                  renderedImagePushSecret:
                    description: |-
                      renderedImagePushSecret is the secret used to connect to a user registry.
                      The final image push and pull secrets should be separate and assume the principal of least privilege.
                      The push secret with write privilege is only required to be present on the node hosting the MachineConfigController pod.
                      The pull secret with read only privileges is required on all nodes.
                      By separating the two secrets, the risk of write credentials becoming compromised is reduced.
                    properties:
                      name:
                        description: |-
                          name is the name of the secret used to push or pull this MachineOSConfig object.
                          Must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character.
                          This secret must be in the openshift-machine-config-operator namespace.
                        maxLength: 253
                        type: string
                        x-kubernetes-validations:
                        - message: a lowercase RFC 1123 subdomain must consist of
                            lower case alphanumeric characters, '-' or '.', and must
                            start and end with an alphanumeric character.
                          rule: '!format.dns1123Subdomain().validate(self).hasValue()'
                    required:
                    - name
                    type: object
                  renderedImagePushSpec:
                    description: |-
                      renderedImagePushSpec describes the location of the final image.
                      The MachineOSConfig object will use the in cluster image registry configuration.
                      If you wish to use a mirror or any other settings specific to registries.conf, please specify those in the cluster wide registries.conf via the cluster image.config, ImageContentSourcePolicies, ImageDigestMirrorSet, or ImageTagMirrorSet objects.
                      The format of the image pushspec is:
                      host[:port][/namespace]/name:<tag> or svc_name.namespace.svc[:port]/repository/name:<tag>
                    maxLength: 447
                    minLength: 1
                    type: string
                    x-kubernetes-validations:
                    - message: the OCI Image name should follow the host[:port][/namespace]/name
                        format, resembling a valid URL without the scheme. Or it must
                        be a valid .svc followed by a port, repository, image name,
                        and tag.
                      rule: self.matches('^([a-zA-Z0-9-]+\\.)+[a-zA-Z0-9-]+(:[0-9]{2,5})?(/[a-zA-Z0-9-_]{1,61})*/[a-zA-Z0-9-_.]+:[a-zA-Z0-9._-]+$')
                        || self.matches('^[^.]+\\.[^.]+\\.svc:\\d+\\/[^\\/]+\\/[^\\/]+:[^\\/]+$')
                required:
                - imageBuilder
                - renderedImagePushSecret
                - renderedImagePushSpec
                type: object
              buildOutputs:
                description: |-
                  buildOutputs holds all information needed to handle booting the image after a build
                  This currently contains a currentImagePullSecret field, which should be provided if the final pull secret used to pull the image to nodes from the registry
                  is different than the one used for pushing the image to the registry during the build.
                properties:
                  currentImagePullSecret:
                    description: |-
                      currentImagePullSecret is the secret used to pull the final produced image.
                      Must live in the openshift-machine-config-operator namespace,
                      the final image push and pull secrets should be separate for security concerns. If the final image push secret is somehow exfiltrated,
                      that gives someone the power to push images to the image repository. By comparison, if the final image pull secret gets exfiltrated,
                      that only gives someone to pull images from the image repository. It's basically the principle of least permissions.
                      This pull secret will be used on all nodes in the pool. These nodes will need to pull the final OS image and boot into it using rpm-ostree or bootc.
                    properties:
                      name:
                        description: |-
                          name is the name of the secret used to push or pull this MachineOSConfig object.
                          Must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character.
                          This secret must be in the openshift-machine-config-operator namespace.
                        maxLength: 253
                        type: string
                        x-kubernetes-validations:
                        - message: a lowercase RFC 1123 subdomain must consist of
                            lower case alphanumeric characters, '-' or '.', and must
                            start and end with an alphanumeric character.
                          rule: '!format.dns1123Subdomain().validate(self).hasValue()'
                    required:
                    - name
                    type: object
                type: object
              machineConfigPool:
                description: machineConfigPool is the pool which the build is for
                properties:
                  name:
                    description: |-
                      name of the MachineConfigPool object.
                      Must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character.
                    maxLength: 253
                    type: string
                    x-kubernetes-validations:
                    - message: a lowercase RFC 1123 subdomain must consist of lower
                        case alphanumeric characters, '-' or '.', and must start and
                        end with an alphanumeric character.
                      rule: '!format.dns1123Subdomain().validate(self).hasValue()'
                required:
                - name
                type: object
            required:
            - buildInputs
            - machineConfigPool
            type: object
          status:
            description: status describes the status of the machineosconfig
            properties:
              currentImagePullspec:
                description: |-
                  currentImagePullspec is the fully qualified image pull spec used by the MCO to pull down the new OSImage. This must include sha256.
                  The format of the image pullspec is:
                  host[:port][/namespace]/name@sha256:<digest>
                  The digest must be 64 characters long, and consist only of lowercase hexadecimal characters, a-f and 0-9.
                maxLength: 447
                minLength: 1
                type: string
                x-kubernetes-validations:
                - message: the OCI Image reference must end with a valid '@sha256:<digest>'
                    suffix, where '<digest>' is 64 characters long
                  rule: (self.split('@').size() == 2 && self.split('@')[1].matches('^sha256:[a-f0-9]{64}$'))
                - message: the OCI Image name should follow the host[:port][/namespace]/name
                    format, resembling a valid URL without the scheme
                  rule: (self.split('@')[0].matches('^([a-zA-Z0-9-]+\\.)+[a-zA-Z0-9-]+(:[0-9]{2,5})?/([a-zA-Z0-9-_]{0,61}/)?[a-zA-Z0-9-_.]*?$'))
              machineOSBuild:
                description: machineOSBuild is a reference to the MachineOSBuild object
                  for this MachineOSConfig, which contains the status for the image
                  build
                properties:
                  group:
                    description: |-
                      group of the referent.
                      The name must contain only lowercase alphanumeric characters, '-' or '.' and start/end with an alphanumeric character
                      Example: "", "apps", "build.openshift.io", etc.
                    maxLength: 253
                    type: string
                    x-kubernetes-validations:
                    - message: a lowercase RFC 1123 subdomain must consist of lower
                        case alphanumeric characters, '-' or '.', and must start and
                        end with an alphanumeric character.
                      rule: '!format.dns1123Subdomain().validate(self).hasValue()'
                  name:
                    description: |-
                      name of the referent.
                      This value should consist of only lowercase alphanumeric characters and hyphens.
                    maxLength: 256
                    minLength: 1
                    type: string
                    x-kubernetes-validations:
                    - message: the value must consist of only lowercase alphanumeric
                        characters and hyphens
                      rule: self.matches('^[a-z0-9]([-a-z0-9]*[a-z0-9])?$')
                  namespace:
                    description: |-
                      namespace of the referent.
                      This value should consist of only lowercase alphanumeric characters and hyphens.
                    maxLength: 63
                    minLength: 1
                    type: string
                    x-kubernetes-validations:
                    - message: the value must consist of only lowercase alphanumeric
                        characters and hyphens
                      rule: self.matches('^[a-z0-9]([-a-z0-9]*[a-z0-9])?$')
                  resource:
                    description: |-
                      resource of the referent.
                      This value should consist of only lowercase alphanumeric characters and hyphens.
                      Example: "deployments", "deploymentconfigs", "pods", etc.
                    maxLength: 63
                    minLength: 1
                    type: string
                    x-kubernetes-validations:
                    - message: the value must consist of only lowercase alphanumeric
                        characters and hyphens
                      rule: self.matches('^[a-z0-9]([-a-z0-9]*[a-z0-9])?$')
                required:
                - group
                - name
                - resource
                type: object
              observedGeneration:
                description: observedGeneration represents the generation of the MachineOSConfig
                  object observed by the Machine Config Operator's build controller.
                format: int64
                minimum: 0
                type: integer
                x-kubernetes-validations:
                - message: observedGeneration must not move backwards except to zero
                  rule: self >= oldSelf || (self == 0 && oldSelf > 0)
            required:
            - observedGeneration
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
